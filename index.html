<!DOCTYPE html>
<html lang="th">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Manowzab Command Center V113.15 (Fix Sync Crash)</title>
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- THEME & LAYOUT --- */
        :root { 
            --bg: #121212; --panel: #1e1e1e; --primary: #d32f2f; --success: #00e676; --text: #e0e0e0; 
            --grid-empty: #2a2a2a; --grid-text: #aaa;
            --grid-sold: #d32f2f; --grid-sold-text: #fff;
            --warn: #ff9800; --info: #29b6f6;
            --ai-active: #9c27b0;
            --pattern-tag: #ff9800;
            --disabled: #555;
            --vacant-price: #ffd700;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'Kanit', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; 
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
            padding-bottom: env(safe-area-inset-bottom); 
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        /* --- HEADER --- */
        .header {
            background: #252525; border-bottom: 1px solid #333;
            display: flex; flex-direction: column; padding: 10px 20px; flex-shrink: 0; gap: 10px;
            position: relative; z-index: 100;
            padding-top: max(10px, env(safe-area-inset-top));
        }
        .header-controls { 
            display: flex; gap: 8px; align-items: center; width: 100%; overflow-x: visible; padding-bottom: 5px; 
            border-bottom: 1px solid #333;
        }
        .header-info { display: flex; align-items: center; gap: 15px; overflow: hidden; width: 100%; padding-top: 2px; }
        
        .status-dot { width: 12px; height: 12px; border-radius: 50%; background: #555; transition: 0.3s; flex-shrink: 0; }
        .status-dot.online { background: var(--success); box-shadow: 0 0 10px var(--success); }
        .live-viewers { font-size: 1.1em; font-weight: bold; color: var(--success); display: flex; align-items: center; gap: 5px; flex-shrink: 0; }
        .live-title { font-size: 1em; color: #aaa; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }
        .version-badge { background: #333; color: #666; padding: 2px 6px; border-radius: 4px; font-size: 0.75em; cursor: help; border: 1px solid #444; font-family: monospace; white-space: nowrap; }

        /* BUTTONS */
        .btn { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; font-family: 'Kanit'; transition: 0.2s; display:flex; align-items:center; gap:5px; font-size: 0.9em; white-space: nowrap; }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: #000; }
        .btn-dark { background: #444; color: #ccc; }
        .btn-sim { background: #ff9800; color: #000; }
        .btn-shipping { background: var(--info); color: #000; }
        .btn-shipping.empty { background: var(--disabled); color: #888; }
        
        .btn-ai { background: #333; color: #777; border: 1px solid #555; }
        .btn-ai.active { background: var(--ai-active); color: #fff; border-color: var(--ai-active); box-shadow: 0 0 10px rgba(156, 39, 176, 0.5); animation: pulseAi 2s infinite; }
        .btn-ai.remote { border: 1px dashed var(--warn); color: var(--warn); opacity: 0.7; }
        
        .btn-voice { background: #009688; color: white; }
        .btn-voice.active { background: #d32f2f; animation: pulseMic 2s infinite; }

        /* DROPDOWN MENU */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content {
            display: none; position: absolute; right: 0; top: 100%; background-color: #333;
            min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.5); z-index: 200;
            border-radius: 6px; border: 1px solid #444; margin-top: 5px;
        }
        .dropdown-content.show { display: block; animation: fadeIn 0.2s; }
        .dropdown-content a {
            color: #eee; padding: 10px 16px; text-decoration: none; display: block;
            font-size: 0.9em; border-bottom: 1px solid #444; cursor: pointer;
        }
        .dropdown-content a:last-child { border-bottom: none; }
        .dropdown-content a:hover { background-color: #444; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* STATUS */
        .status-cluster { display: flex; gap: 8px; background: #1a1a1a; padding: 4px 10px; border-radius: 6px; border: 1px solid #333; margin-right: 5px; align-items: center; flex-shrink: 0; }
        .status-item { font-size: 0.9em; opacity: 0.4; filter: grayscale(100%); transition: 0.3s; cursor: help; }
        .status-item.ok { opacity: 1; filter: none; color: var(--success); }
        .status-item.err { opacity: 1; filter: none; color: var(--primary); animation: pulseRed 1s infinite; }
        .key-indicator { font-size: 0.8em; color: #fff; opacity: 0.8; font-family: monospace; border-left: 1px solid #444; padding-left: 8px; margin-left: 2px; }
        .input-id { background: #333; border: 1px solid #444; color: #fff; padding: 6px 10px; border-radius: 6px; width: 120px; text-align: center; font-family: monospace; }
        .mic-status { display: none; color: #fff; background: #d32f2f; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; animation: pulseMic 1.5s infinite; margin-left: auto; }

        /* ANIMATIONS */
        @keyframes pulseAi { 0% { box-shadow: 0 0 5px rgba(156, 39, 176, 0.5); } 50% { box-shadow: 0 0 15px rgba(156, 39, 176, 0.8); } 100% { box-shadow: 0 0 5px rgba(156, 39, 176, 0.5); } }
        @keyframes pulseRed { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        @keyframes pulseMic { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        @keyframes highlightBox { 0% { transform: scale(1.1); box-shadow: 0 0 20px #ffeb3b; } 100% { transform: scale(1); } }
        
        @keyframes blinkBorder { 
            0% { border-color: var(--success); box-shadow: 0 0 5px var(--success); } 
            50% { border-color: transparent; box-shadow: none; } 
            100% { border-color: var(--success); box-shadow: 0 0 5px var(--success); } 
        }
        .blinking-border { animation: blinkBorder 1s infinite; animation-iteration-count: 15; }

        /* AWAY BANNER - FIX Z-INDEX & VISIBILITY */
        .away-banner {
            position: fixed; top: 60px; left: 50%; transform: translateX(-50%);
            background: linear-gradient(45deg, #6a1b9a, #8e24aa);
            color: white; padding: 10px 25px; border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.6); z-index: 9999; /* Maximum Priority */
            display: none; align-items: center; gap: 15px;
            font-size: 1.2em; border: 2px solid #ce93d8;
            animation: pulseAi 2s infinite; white-space: nowrap;
            /* iPad tweak: move down slightly if needed */
            top: max(60px, calc(env(safe-area-inset-top) + 60px));
        }
        .away-timer { font-family: monospace; font-size: 1.3em; font-weight: bold; background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 5px; }
        .away-btn { background: #fff; color: #6a1b9a; border: none; padding: 5px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; }
        .away-btn:hover { background: #f3e5f5; }

        /* MAIN LAYOUT */
        .main-container { display: flex; flex: 1; overflow: hidden; position: relative; }
        
        /* STOCK */
        .stock-panel { flex: 2; border-right: 1px solid #333; display: flex; flex-direction: column; background: #181818; padding: 15px; overflow-y: auto; scroll-behavior: smooth; }
        .stock-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .stock-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 8px; padding-bottom: 50px; }
        .stock-item { aspect-ratio: 1/0.8; background: var(--grid-empty); border-radius: 8px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; position: relative; transition: 0.2s; user-select: none; border: 1px solid #333; }
        .stock-item:hover { border-color: #666; transform: translateY(-2px); }
        .stock-item.highlight { animation: highlightBox 1s ease-out; z-index: 5; border-color: #ffeb3b; }
        
        .stock-num { font-size: 1.8em; font-weight: bold; color: #444; position: absolute; top: 2px; left: 8px; }
        .stock-status { font-size: 0.9em; margin-top: 20px; text-align: center; color: #888; font-weight: normal; padding: 0 4px; word-break: break-word; line-height: 1.2; }
        .stock-price { position: absolute; bottom: 2px; right: 5px; font-size: 0.8em; color: #ffd700; display: none; }
        .stock-size { position: absolute; bottom: 2px; left: 5px; font-size: 0.7em; color: #aaa; }
        
        .stock-item.sold { background: rgba(211, 47, 47, 0.15); border: 2px solid var(--primary); }
        .stock-item.sold .stock-num { color: rgba(255,255,255,0.5); }
        .stock-item.sold .stock-status { color: #fff; font-weight: bold; text-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .stock-item.sold .stock-price { display: block; }
        
        /* Source Icon */
        .stock-item.sold .source-icon { display: block; }
        .source-icon { position: absolute; bottom: 5px; left: 5px; font-size: 14px; display: none; top: auto; right: auto; }

        .queue-badge { position: absolute; top: -5px; right: -5px; background: #ff9800; color: #000; font-size: 0.8em; font-weight: bold; padding: 2px 6px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.5); z-index: 10; }

        /* CHAT */
        .chat-panel { flex: 1; display: flex; flex-direction: column; min-width: 350px; max-width: 480px; background: #0f0f0f; position: relative; }
        .tools-bar { padding: 10px; border-bottom: 1px solid #333; display: flex; gap: 8px; overflow-x: auto; background: #151515; align-items: center; }
        #chat-viewport { flex: 1; overflow-y: auto; padding: 10px; scroll-behavior: smooth; }
        .chat-row { display: flex; align-items: flex-start; padding: 10px; margin-bottom: 6px; border-radius: 8px; background: #1e1e1e; border-left: 4px solid transparent; animation: slideIn 0.2s; }
        .chat-row.cf { border-left-color: var(--success); background: rgba(0, 230, 118, 0.1); }
        .chat-row.cancel { border-left-color: var(--primary); background: rgba(211, 47, 47, 0.1); }
        .avatar { width: 38px; height: 38px; border-radius: 50%; margin-right: 12px; border: 1px solid #333; }
        .chat-header { margin-bottom: 4px; display: flex; align-items: center; flex-wrap: wrap; gap: 6px; }
        .badge-nick { padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 0.9em; cursor: pointer; color: #000; }
        .chat-msg { color: #ddd; line-height: 1.5; word-break: break-word; }
        .vip-admin { background: linear-gradient(45deg, #FFD700, #FFF8DC, #DAA520) !important; color: #000 !important; border: 1px solid #B8860B !important; box-shadow: 0 0 10px rgba(255, 215, 0, 0.6) !important; animation: vipGlow 2s infinite alternate; }
        
        /* Detection Tags (Icon Only) */
        .tag-source { display: inline-flex; align-items: center; margin-left: 5px; padding: 0; background: none; border: none; box-shadow: none; opacity: 0.9; }
        .tag-source i { font-size: 1.1em; } 
        .tag-source.regex i { color: var(--pattern-tag); text-shadow: 0 0 5px rgba(255, 183, 77, 0.3); }
        .tag-source.ai i { color: var(--ai-active); text-shadow: 0 0 5px rgba(156, 39, 176, 0.3); }
        
        .scroll-bottom-btn { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(33, 150, 243, 0.9); color: white; border: none; border-radius: 20px; padding: 8px 15px; font-size: 0.9em; cursor: pointer; display: none; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.5); animation: bounce 2s infinite; }

        /* OVERLAYS */
        .dashboard-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #121212; z-index: 999; display: none; flex-direction: column; padding: 20px; overflow-y: auto; }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .shipping-table { width: 100%; border-collapse: collapse; color: #ddd; }
        .shipping-table th, .shipping-table td { padding: 10px; border-bottom: 1px solid #333; text-align: left; }
        .address-box { width: 100%; background: #222; border: 1px solid #444; color: #fff; padding: 5px; min-height: 60px; font-family: 'Kanit'; }
        .edit-input { background: #222; border: 1px solid #444; color: #fff; padding: 4px; border-radius: 4px; width: 100%; }
        
        @media print { body * { visibility: hidden; } #print-area, #print-area * { visibility: visible; } #print-area { position: absolute; left: 0; top: 0; width: 100%; padding: 20px; background: white; color: black; } .print-label { border: 2px solid black; padding: 20px; margin-bottom: 20px; page-break-inside: avoid; } }
    </style>
</head>
<body>

    <div class="header">
        <!-- Row 1: Controls -->
        <div class="header-controls">
            <div class="status-cluster">
                <span id="stat-db" class="status-item" title="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Firebase">üóÑÔ∏è</span>
                <span id="stat-api" class="status-item" title="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ YouTube API">‚òÅÔ∏è</span>
                <span id="stat-chat" class="status-item" title="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡πÅ‡∏ä‡∏ó">üì°</span>
                <span id="stat-key" class="key-indicator" title="API Key ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà">üîë 1</span>
            </div>
            
            <button class="btn btn-voice" id="btnVoice" onclick="window.toggleVoiceControl()">üéôÔ∏è</button>
            <button class="btn btn-ai inactive" id="btnAICommander" onclick="window.toggleAICommander()">ü§ñ AI: ‡∏õ‡∏¥‡∏î</button>
            <button class="btn btn-dark" onclick="window.openHistory()">üïí</button>
            <button id="btn-shipping" class="btn btn-shipping empty" onclick="window.openDashboard()">üöö (0)</button>
            
            <input type="text" id="vidInput" class="input-id" placeholder="Video ID">
            <button class="btn btn-primary" id="btnConnect" onclick="window.toggleConnection()">CONNECT</button>
            
            <!-- Tools Dropdown -->
            <div class="dropdown">
                <button class="btn btn-sim" onclick="window.toggleDropdown()">‚ö° Tools <i class="fa-solid fa-caret-down"></i></button>
                <div id="toolsDropdown" class="dropdown-content">
                    <a onclick="window.testVoice()">üîä ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á</a>
                    <a onclick="window.toggleFullScreen()">üì∫ ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ (iPad)</a>
                    <a onclick="window.toggleAwayMode()">üåô ‡πÇ‡∏´‡∏°‡∏î‡∏û‡∏≤‡∏•‡∏π‡∏Å‡∏ô‡∏≠‡∏ô</a>
                    <a onclick="window.toggleSimulation()" id="menuSim">‚ö° ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÅ‡∏ä‡∏ó</a>
                    <a onclick="window.askAiKey()">üîë ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API Key</a>
                    <a onclick="window.fixDatabase()">üîß ‡∏ã‡πà‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•/‡∏à‡∏±‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö</a>
                </div>
            </div>
        </div>

        <!-- Row 2: Live Info -->
        <div class="header-info">
            <div class="status-dot" id="status-dot"></div>
            <div class="live-viewers" id="view-counter">üëÅÔ∏è 0</div>
            <div class="live-title" id="live-title">Offline Mode</div>
            <div class="version-badge" style="margin-left: auto;">V113.15 (Fix Sync Crash)</div>
        </div>
    </div>

    <div id="awayBanner" class="away-banner">
        <span>üåô ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏û‡∏≤‡∏•‡∏π‡∏Å‡∏ô‡∏≠‡∏ô</span>
        <span id="awayTimer" class="away-timer">00:00</span>
        <button class="away-btn" onclick="window.toggleAwayMode()">‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß</button>
    </div>

    <div class="main-container">
        <!-- Stock Panel -->
        <div class="stock-panel" id="stockPanel">
            <div class="stock-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <input type="number" id="stockSize" value="70" style="width:60px; background:#333; border:none; color:white; text-align:center; border-radius:4px; padding:5px;" onchange="window.saveStockSize(this.value)">
                    <span style="font-size:0.8em; color:#aaa;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                    <button class="btn btn-dark" onclick="window.adjustGridZoom(-0.1)">-</button>
                    <button class="btn btn-dark" onclick="window.adjustGridZoom(0.1)">+</button>
                </div>
                <div class="stock-stats">‡∏à‡∏≠‡∏á <span id="sold-count" class="stat-sold">0</span> / <span id="total-count">70</span></div>
                <button class="btn btn-dark" onclick="window.clearAllStock()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á</button>
            </div>
            <div class="stock-grid" id="stockGrid"></div>
        </div>

        <!-- Chat Panel -->
        <div class="chat-panel">
            <div class="tools-bar">
                <button class="btn btn-mute active" id="btnSound" onclick="window.toggleSound()">üîä ‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ‡πÄ‡∏õ‡∏¥‡∏î</button>
                <button class="btn btn-dark" onclick="window.resetVoice()">üîá Reset</button>
                <div style="margin-left:auto; display:flex; gap:2px;">
                    <button class="btn btn-dark" onclick="window.adjustZoom(-2)">A-</button>
                    <button class="btn btn-dark" onclick="window.adjustZoom(2)">A+</button>
                </div>
            </div>
            <div id="chat-viewport"><div id="chat-list"></div></div>
            <button id="btn-scroll-down" class="scroll-bottom-btn" onclick="window.scrollToBottom()">‚¨áÔ∏è ‡πÅ‡∏ä‡∏ó‡πÉ‡∏´‡∏°‡πà</button>
        </div>

        <!-- Hidden Elements -->
        <div id="dashboard" class="dashboard-overlay">
            <div class="dashboard-header"><div class="dash-title">üöö ‡∏Ñ‡∏¥‡∏ß‡∏à‡∏±‡∏î‡∏™‡πà‡∏á (‡∏£‡∏≠‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</div><button class="btn btn-dark" onclick="window.closeDashboard()">‡∏õ‡∏¥‡∏î</button></div>
            <div style="overflow-x:auto;"><table class="shipping-table"><thead><tr><th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th><th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th></tr></thead><tbody id="shipping-body"></tbody></table></div>
        </div>
        <div id="history-modal" class="dashboard-overlay">
            <div class="dashboard-header"><div class="dash-title">üïí ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÑ‡∏•‡∏ü‡πå</div><button class="btn btn-dark" onclick="window.closeHistory()">‡∏õ‡∏¥‡∏î</button></div>
            <div style="overflow-y:auto;"><ul id="history-list" class="history-list"></ul></div>
        </div>
    </div>
    <div id="print-area"></div>

    <!-- Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getDatabase, ref, set, update, remove, onValue, get, serverTimestamp, query, orderByChild } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        const app = initializeApp({ apiKey: "AIzaSyAVYqEmdw-AwS1tCElhSaXDLP1Aq35chp0", authDomain: "manowlive-chat.firebaseapp.com", databaseURL: "https://manowlive-chat-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "manowlive-chat" });
        const db = getDatabase(app);
        const auth = getAuth(app);

        // --- GLOBAL STATE ---
        const API_KEYS = ["AIzaSyAVzYQN51V-kITnyJWGy8IVSktitxrVD8g", "AIzaSyBlnw6tpETYu61XSNqd7zXt25Fv_vmbWJU", "AIzaSyAX3dwUqBFeCBjjZixVnlcBz56gAfNWzs0", "AIzaSyAxjRAs01mpt-NxQiR3yStr6Q-57EiQq64"];
        let currentKeyIdx = 0, isConnected = false, isConnecting = false, isSimulating = false;
        let myDeviceId = 'dev-' + Math.random().toString(36).substr(2, 9); 
        let isAiCommander = false; 
        let geminiApiKey = localStorage.getItem('geminiApiKey') || '';
        
        let currentVideoId = 'demo';
        let stockData = {}, savedNames = {}, shippingData = {}, seenMessageIds = {};
        let intervalId, viewerIntervalId, simIntervalId, autoDisconnectTimer, chatTimeoutId;
        let activeChatId = '', chatToken = '', lastScrollTimestamp = 0;
        let unsubscribeStock, unsubscribeSystem, unsubscribeShipping;
        let currentFontSize = 16, currentGridSize = 1;
        let isUserScrolledUp = false;
        
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const synth = window.speechSynthesis;
        let speechQueue = [], isSpeaking = false, isSoundOn = true;
        let activeUtterance = null;

        // Away Mode Variables
        let isAway = false;
        let awayStartTime = 0;
        let awayInterval = null;

        // --- 1. UTILS & HELPERS ---
        function stringToColor(str) { var hash = 0; for (var i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash); return 'hsl(' + (Math.abs(hash) % 360) + ', 85%, 75%)'; }
        function escapeHtml(text) { if (!text) return ""; return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
        function updateStatusIcon(id, status) { document.getElementById(id).className = 'status-item ' + status; }
        function setLoading(s) { document.getElementById('btnConnect').disabled = s; }
        function formatThaiDate(timestamp) { const date = new Date(timestamp); const months = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."]; return date.getDate() + ' ' + months[date.getMonth()] + ' ' + (date.getFullYear() + 543) + ' (' + date.getHours().toString().padStart(2, '0') + ':' + date.getMinutes().toString().padStart(2, '0') + ')'; }
        function updateKeyDisplay() { document.getElementById('stat-key').innerText = "üîë " + (currentKeyIdx + 1); }
        
        function saveHistory(vid, title) { 
            if(vid && vid!=='demo') set(ref(db, 'history/'+vid), {title, timestamp: serverTimestamp()}); 
        }

        // --- 2. AUDIO SYSTEM ---
        function unlockAudio() {
            if (audioCtx.state === 'suspended') {
                audioCtx.resume().then(() => {
                    const u = new SpeechSynthesisUtterance(" ");
                    synth.speak(u);
                });
            }
        }
        document.addEventListener('click', () => { unlockAudio(); }, { once: true });

        function toggleSound() { 
            isSoundOn = !isSoundOn; 
            const btn = document.getElementById('btnSound');
            if (isSoundOn) {
                btn.className = 'btn btn-mute active';
                btn.innerText = 'üîä ‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ‡πÄ‡∏õ‡∏¥‡∏î';
                unlockAudio(); 
                queueSpeech("‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ñ‡πà‡∏∞"); 
            } else { 
                btn.className = 'btn btn-mute';
                btn.innerText = 'üîá ‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ‡∏õ‡∏¥‡∏î';
                resetVoice(); 
            }
        }
        function resetVoice() { synth.cancel(); speechQueue = []; isSpeaking = false; if(isSoundOn) queueSpeech("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß"); }
        function queueSpeech(txt) { if(!isSoundOn) return; speechQueue.push(txt); if (!isSpeaking) processQueue(); }
        function processQueue() {
            if (speechQueue.length === 0) { isSpeaking = false; return; }
            if (synth.speaking && !isSpeaking) { synth.cancel(); }
            isSpeaking = true;
            const u = new SpeechSynthesisUtterance(speechQueue.shift());
            u.lang = 'th-TH';
            const voices = synth.getVoices();
            const thVoice = voices.find(v => v.lang.includes('th'));
            if (thVoice) u.voice = thVoice;
            u.onend = () => { isSpeaking = false; processQueue(); };
            u.onerror = (e) => { console.error("TTS Error:", e.error); isSpeaking = false; processQueue(); };
            activeUtterance = u; 
            synth.speak(u);
        }
        
        window.testVoice = () => {
            queueSpeech("‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏´‡∏ô‡∏∂‡πà‡∏á ‡∏™‡∏≠‡∏á ‡∏™‡∏≤‡∏° ‡∏™‡∏µ‡πà ‡∏´‡πâ‡∏≤");
        };

        function playDing() { if(!isSoundOn) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.frequency.setValueAtTime(800, audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime+0.1); g.gain.setValueAtTime(0.3, audioCtx.currentTime); g.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime+0.1); o.start(); o.stop(audioCtx.currentTime+0.1); }
        function playCancel() { if(!isSoundOn) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type='sawtooth'; o.connect(g); g.connect(audioCtx.destination); o.frequency.setValueAtTime(150, audioCtx.currentTime); g.gain.setValueAtTime(0.2, audioCtx.currentTime); o.start(); o.stop(audioCtx.currentTime+0.3); }
        setInterval(() => { if (!synth.speaking && speechQueue.length > 0 && !isSpeaking) processQueue(); }, 1000);

        // --- 3. CORE UI FUNCTIONS ---
        function askName(uid, old) { 
            Swal.fire({title: '‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô', input: 'text', inputValue: old}).then(r => { 
                if (r.value) update(ref(db, `nicknames/${uid}`), {nick: r.value}); 
            }); 
        }

        function updateAllChatNames() {
            document.querySelectorAll('.chat-header').forEach(function(el) {
                const uid = el.getAttribute('data-uid');
                const realName = el.getAttribute('data-realname');
                if (uid && realName) el.innerHTML = generateNameHtml(uid, realName);
            });
        }

        function updateShippingButton() {
            let count = 0;
            const activeBuyerUids = new Set();
            Object.keys(stockData).forEach(key => { 
                if (stockData[key].uid) activeBuyerUids.add(stockData[key].uid); 
            });

            if (shippingData && shippingData[currentVideoId]) {
                const videoShipping = shippingData[currentVideoId];
                count = Object.keys(videoShipping).filter(uid => videoShipping[uid].ready && activeBuyerUids.has(uid)).length;
            }
            
            const btn = document.getElementById('btn-shipping');
            btn.innerText = 'üöö (' + count + ')'; 
            btn.className = count > 0 ? 'btn btn-shipping' : 'btn btn-shipping empty';
        }

        function renderDashboardTable() {
            const tbody = document.getElementById('shipping-body'); tbody.innerHTML = '';
            const userOrders = {};
            
            Object.keys(stockData).forEach(num => {
                const item = stockData[num]; const uid = item.uid;
                if (!userOrders[uid]) userOrders[uid] = { name: item.owner, items: [], totalPrice: 0, uid: uid };
                const price = item.price ? parseInt(item.price) : 0;
                userOrders[uid].items.push({ num: num, price: price }); userOrders[uid].totalPrice += price;
            });

            let index = 1; 
            for (const uid in userOrders) {
                const order = userOrders[uid]; 
                let custData = savedNames[uid] || { nick: order.name };
                
                const tr = document.createElement('tr');
                const itemStr = order.items.map(i => '#' + i.num + (i.price > 0 ? '('+i.price+')' : '')).join(', ');
                
                tr.innerHTML = `<td>${index++}</td><td><input class="edit-input" value="${custData.nick||order.name}" onchange="window.askName('${uid}', this.value)"></td><td>${itemStr}</td>`;
                tbody.appendChild(tr);
            }
        }

        function generateNameHtml(uid, realName) {
            const color = stringToColor(uid); 
            let nick = realName;
            let displayName = realName;
            let isNickSet = false;

            if (savedNames[uid]) {
                if (typeof savedNames[uid] === 'object') {
                    nick = savedNames[uid].nick;
                } else {
                     nick = savedNames[uid]; 
                }
                isNickSet = true;
                displayName = nick;
            }
            
            const valueToEdit = isNickSet ? nick : realName;
            let vipClass = "";
            if (/admin|‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô/i.test(displayName) || /admin|‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô/i.test(realName)) vipClass = "vip-admin";

            if (isNickSet) {
                return `<div><span class="badge-nick ${vipClass}" style="${!vipClass?'background:'+color:''}" data-val="${escapeHtml(valueToEdit)}" onclick="window.askName('${uid}', this.getAttribute('data-val'))">${displayName}</span> <span class="real-name-sub">(${realName})</span></div>`;
            }
            return `<span class="badge-real ${vipClass}" style="color:${color}" data-val="${escapeHtml(realName)}" onclick="window.askName('${uid}', this.getAttribute('data-val'))">${realName}</span>`;
        }

        // --- CHAT RENDERING & SCROLL LOGIC ---
        function renderChat(name, msg, type, uid, img, realName, detectionMethod = null) {
            const div = document.createElement('div'); div.className = `chat-row ${type} new-msg`;
            
            let tagHtml = '';
            if (detectionMethod === 'regex') tagHtml = '<button class="tag-source regex" title="‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Pattern"><i class="fa-solid fa-bolt"></i></button>';
            else if (detectionMethod === 'ai') tagHtml = '<button class="tag-source ai" title="‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢ AI"><i class="fa-solid fa-robot"></i></button>';

            div.innerHTML = `<img src="${img}" class="avatar"><div class="chat-content"><div class="chat-header" data-uid="${uid}" data-realname="${escapeHtml(realName)}">${generateNameHtml(uid, realName)} ${tagHtml}</div><div class="chat-msg">${msg}</div></div>`;
            const list = document.getElementById('chat-list');
            list.appendChild(div);
            
            const vp = document.getElementById('chat-viewport');
            if (!isUserScrolledUp) {
                vp.scrollTop = vp.scrollHeight; 
            } else {
                document.getElementById('btn-scroll-down').style.display = 'block'; 
            }
        }

        function scrollToBottom() {
            const vp = document.getElementById('chat-viewport');
            vp.scrollTop = vp.scrollHeight;
            isUserScrolledUp = false;
            document.getElementById('btn-scroll-down').style.display = 'none';
        }

        // --- 4. BUSINESS LOGIC ---
        async function analyzeChatWithAI(text) {
            if (!geminiApiKey || !isAiCommander) return null;
            
            const prompt = `
Role: You are an AI assistant for a Thai live commerce clothing shop (Manowzab). 
Your task is to extract the user's intent from their chat message.

Key Entities:
- **Product ID**: Usually a number (e.g., 1, 15, 99) or starts with F/CF (e.g., F1, CF10).
- **Price**: A number usually followed by "‡∏ö‡∏≤‡∏ó" or appearing after the ID (e.g., 10=100).

Intents:
1. **buy**: User wants to purchase an item.
   - Pattern: "[ID]", "F[ID]", "CF[ID]", "‡∏£‡∏±‡∏ö [ID]", "[ID] [Name]", "[ID]=[Price]".
   - Examples: "10", "F10", "10 ‡∏Ñ‡∏£‡∏±‡∏ö", "10 ‡∏ô‡πâ‡∏≠‡∏á‡∏ö‡∏µ", "10 100", "‡πÄ‡∏≠‡∏≤ 10".
   - CRITICAL EXCEPTION: If the message contains specific question words (‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà, ‡πÑ‡∏´‡∏°, ‡∏´‡∏£‡∏≠, ‡∏´‡∏£‡∏∑‡∏≠, ‡πÑ‡∏á) OR specific attribute words (‡∏≠‡∏Å, ‡πÄ‡∏≠‡∏ß, ‡∏¢‡∏≤‡∏ß, ‡∏™‡∏µ, ‡∏ú‡πâ‡∏≤, ‡∏ï‡∏≥‡∏´‡∏ô‡∏¥) appearing alongside a number, it is ALWAYS a "question", NOT a "buy".
     - "50 ‡∏™‡∏µ‡∏≠‡∏∞‡πÑ‡∏£" -> question
     - "10 ‡∏≠‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà" -> question
     - "50 ‡∏°‡∏µ‡∏ï‡∏≥‡∏´‡∏ô‡∏¥‡πÑ‡∏´‡∏°" -> question
     - "‡∏ú‡πâ‡∏≤‡∏≠‡∏∞‡πÑ‡∏£ 10" -> question

2. **cancel**: User wants to cancel an order.
   - Pattern: "CC", "cancel", "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å", "‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤".
   - Examples: "CC 10", "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å 10", "‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤ 10 ‡πÅ‡∏•‡πâ‡∏ß".

3. **question**: User is asking about product details.
   - Keywords: ‡∏≠‡∏Å, ‡πÄ‡∏≠‡∏ß, ‡∏¢‡∏≤‡∏ß, ‡∏ú‡πâ‡∏≤, ‡∏£‡∏≤‡∏Ñ‡∏≤, ‡∏™‡∏µ, ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏´‡∏°, ‡∏ó‡∏±‡∏ô‡πÑ‡∏´‡∏°, ‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà, ‡∏Å‡∏µ‡πà‡∏ö‡∏≤‡∏ó, ‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô, ‡∏î‡∏π, ‡∏ï‡∏≥‡∏´‡∏ô‡∏¥.
   - Examples: "10 ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏´‡∏°", "‡∏≠‡∏Å 50 ‡πÑ‡∏´‡∏°", "‡∏Ç‡∏≠‡∏î‡∏π 10", "50 ‡∏™‡∏µ‡∏≠‡∏∞‡πÑ‡∏£".

4. **shipping**: User wants to ship items.
   - Keywords: "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á", "‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î", "‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á", "‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô".

5. **spam**: Greetings, chit-chat.

Response Format (JSON only):
{"intent": "buy"|"cancel"|"question"|"shipping"|"spam", "id": number|null, "price": number|null}

Input Message: "${text}"
`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiApiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const result = await response.json();
                const match = result.candidates?.[0]?.content?.parts?.[0]?.text?.match(/\{.*?\}/s);
                return match ? JSON.parse(match[0]) : null;
            } catch (e) { return null; }
        }

        async function processMessage(item) {
            if (!item.snippet || !item.authorDetails) return; 
            if (seenMessageIds[item.id]) return; seenMessageIds[item.id] = true;
            const msg = item.snippet.displayMessage || ""; if (!msg) return;

            const uid = item.authorDetails.channelId; 
            const realName = item.authorDetails.displayName;
            let nick = realName; if(savedNames[uid]) nick = (typeof savedNames[uid] === 'object') ? savedNames[uid].nick : savedNames[uid];
            const isAdmin = /admin|‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô/i.test(nick);
            
            // Fix 2: Stats Update - Get correct stock size from DOM or DB, not just default
            let stockSize = parseInt(document.getElementById('stockSize').value) || 70;
            let intent = null, targetId = null, targetPrice = null, method = null;

            // STRATEGY: AI First (If Active)
            if (isAiCommander) {
                const aiResult = await analyzeChatWithAI(msg);
                if (aiResult) {
                    if (aiResult.intent === 'buy' && aiResult.id) {
                        intent = 'buy'; targetId = aiResult.id; targetPrice = aiResult.price; method = 'ai';
                    } else if (aiResult.intent === 'cancel' && aiResult.id) {
                        intent = 'cancel'; targetId = aiResult.id; method = 'ai';
                    } else if (aiResult.intent === 'shipping') {
                        const shipPath = `shipping/${currentVideoId}/${uid}`;
                        update(ref(db, shipPath), {ready: true, timestamp: Date.now()}).then(() => queueSpeech(nick + " ‡πÅ‡∏à‡πâ‡∏á‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á"));
                        method = 'ai';
                    } else if (aiResult.intent === 'question') {
                        method = 'ai-skip'; // AI identified question -> Skip Regex
                    }
                }
            }

            // Fallback to Regex ONLY if AI wasn't used or failed (and method isn't 'ai-skip')
            if (!method) {
                const buyRegex = /(?:^|[\s])(?:F|f|cf|CF|‡∏£‡∏±‡∏ö|‡πÄ‡∏≠‡∏≤)?\s*(\d+)(?:[\s=\/]+(\d+))?(?:$|[\s])/; 
                const cancelRegex = /(?:^|[\s])(?:cc|CC|cancel|‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å|‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤|‡∏õ‡∏•‡πà‡∏≠‡∏¢|‡∏´‡∏•‡∏∏‡∏î)\s*(\d+)(?:$|[\s])/i;
                
                // Enhanced Question Guard for Regex
                const isQuestion = /‡∏≠‡∏Å|‡πÄ‡∏≠‡∏ß|‡∏¢‡∏≤‡∏ß|‡∏£‡∏≤‡∏Ñ‡∏≤|‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà|‡∏ó‡πÑ‡∏´‡∏£|‡∏Å‡∏µ‡πà‡∏ö‡∏≤‡∏ó|‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô|‡∏ú‡πâ‡∏≤|‡∏™‡∏µ|‡∏ï‡∏≥‡∏´‡∏ô‡∏¥|‡πÑ‡∏´‡∏°/i.test(msg);

                const cMatch = msg.match(cancelRegex);
                const bMatch = msg.match(buyRegex);

                if (cMatch) { 
                    intent = 'cancel'; targetId = parseInt(cMatch[1]); method = 'regex';
                } else if (bMatch && !isQuestion) { 
                    intent = 'buy'; targetId = parseInt(bMatch[1]); targetPrice = bMatch[2] ? parseInt(bMatch[2]) : null; method = 'regex';
                }
            }

            renderChat(nick, msg, isAdmin ? 'admin' : 'normal', uid, item.authorDetails.profileImageUrl, realName, method);
            
            let speakMsg = msg.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g, '');
            if (speakMsg.trim().length > 0 && speakMsg.length < 100) queueSpeech(nick + " ... " + speakMsg);

            if (method === 'ai-skip') return; 

            if (targetId && targetId > 0) {
                // Fix 3: Auto-Expand Stock Logic
                if (targetId > stockSize) {
                    // Auto-expand local and DB
                    stockSize = targetId;
                    saveStockSize(stockSize); // Sync to DB
                    document.getElementById('stockSize').value = stockSize;
                }

                if (intent === 'buy') {
                    let ownerName = nick, ownerUid = uid;
                    if (isAdmin) {
                        let cleanName = msg;
                        cleanName = cleanName.replace(targetId.toString(), '').replace(/f|cf|‡∏£‡∏±‡∏ö|‡πÄ‡∏≠‡∏≤|=/gi, '');
                        if (targetPrice) cleanName = cleanName.replace(targetPrice.toString(), '');
                        cleanName = cleanName.replace(/^[:=\-\s]+|[:=\-\s]+$/g, '').trim();
                        if (cleanName.length > 0) { ownerName = cleanName; ownerUid = 'admin-proxy-' + Date.now(); } 
                        else { ownerName = "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Admin)"; ownerUid = 'admin-proxy-' + Date.now(); }
                    }
                    processOrder(targetId, ownerName, ownerUid, 'chat', targetPrice, method); 
                } else if (intent === 'cancel') {
                    if (isAdmin || (stockData[targetId] && stockData[targetId].uid === uid)) {
                        processCancel(targetId, isAdmin ? '‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' : '‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞');
                    }
                }
            }
        }

        function processOrder(num, owner, uid, src, price, method = 'manual') {
            // Fix 1: Admin Duplicate Check
            if (stockData[num]) {
                const current = stockData[num];
                if (current.owner === owner) return; 
                if (current.queue?.find(q => q.owner === owner)) return;
            }

            if (!stockData[num]) {
                const data = { owner, uid, time: Date.now(), queue: [], source: method }; 
                if (price) data.price = price;
                set(ref(db, `stock/${currentVideoId}/${num}`), data).then(()=> playDing());
            } else {
                const current = stockData[num];
                if (current.uid === uid) return; 
                if (current.queue?.find(q => q.uid === uid)) return;
                const newQ = current.queue || [];
                newQ.push({ owner, uid, time: Date.now() });
                set(ref(db, `stock/${currentVideoId}/${num}/queue`), newQ);
            }
        }

        // Fixed Process Cancel Logic with Immediate Queue Promotion
        function processCancel(num, reason) {
            if (!stockData[num]) return;
            const current = stockData[num];
            // Check if queue exists and has items
            if (current.queue && Array.isArray(current.queue) && current.queue.length > 0) {
                const next = current.queue[0];
                const nextQ = current.queue.slice(1);
                // Promote next user immediately
                const newData = { 
                    owner: next.owner, 
                    uid: next.uid, 
                    time: Date.now(), 
                    queue: nextQ, 
                    source: 'queue' 
                };
                if (current.price) newData.price = current.price;
                
                set(ref(db, `stock/${currentVideoId}/${num}`), newData).then(() => queueSpeech(`‡πÄ‡∏ö‡∏≠‡∏£‡πå ${num} ‡∏´‡∏•‡∏∏‡∏î‡∏à‡∏≠‡∏á ‡∏Ñ‡∏∏‡∏ì ${next.owner} ‡πÑ‡∏î‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå`));
            } else {
                // No queue, just remove
                remove(ref(db, `stock/${currentVideoId}/${num}`)).then(() => { playCancel(); if(reason) queueSpeech(reason); });
            }
        }

        function renderGrid() {
            const size = parseInt(document.getElementById('stockSize').value) || 70;
            const grid = document.getElementById('stockGrid');
            if (grid.children.length !== size) {
                grid.innerHTML = '';
                for(let i=1; i<=size; i++) {
                    const div = document.createElement('div'); div.className = 'stock-item'; div.id = 'stock-'+i;
                    div.onclick = () => window.handleStockClick(i);
                    div.innerHTML = `<span class="stock-num">${i}</span><span class="lock-icon">üîí</span><div class="queue-badge" id="qbadge-${i}" style="display:none"></div><span class="stock-status" id="status-${i}">‡∏ß‡πà‡∏≤‡∏á</span><span class="stock-price" id="price-${i}"></span><span class="source-icon"></span>`;
                    grid.appendChild(div);
                }
            }
            let latestId = null; let maxTime = lastScrollTimestamp;
            Object.keys(stockData).forEach(key => {
                const item = stockData[key]; renderSlot(key, item);
                if (item.time > maxTime) { maxTime = item.time; latestId = key; }
                item.queue?.forEach(q => { if(q.time > maxTime) { maxTime = q.time; latestId = key; } });
            });
            for(let i=1; i<=size; i++) { if(!stockData[i]) { const el = document.getElementById('stock-'+i); if(el) { el.className='stock-item'; el.classList.remove('blinking-border'); document.getElementById(`status-${i}`).innerText='‡∏ß‡πà‡∏≤‡∏á'; document.getElementById(`price-${i}`).innerText=''; document.getElementById(`qbadge-${i}`).style.display='none'; el.querySelector('.lock-icon').style.display='none'; el.querySelector('.source-icon').style.display='none'; } } }
            if (latestId) { lastScrollTimestamp = maxTime; const target = document.getElementById('stock-'+latestId); if (target) { target.scrollIntoView({behavior:'smooth', block:'center'}); target.classList.add('highlight'); setTimeout(()=>target.classList.remove('highlight'), 1000); } }
        }
        
        function renderSlot(num, data) {
            const el = document.getElementById('stock-' + num); if(!el) return;
            
            // Handle Vacant item with Price (No Owner)
            if (!data.owner) {
                el.className = 'stock-item';
                document.getElementById(`status-${num}`).innerText = '‡∏ß‡πà‡∏≤‡∏á';
                if (data.price) {
                    const pEl = document.getElementById(`price-${num}`);
                    pEl.innerText = '‡∏ø' + data.price;
                    pEl.style.display = 'block';
                    pEl.style.color = 'var(--vacant-price)'; // Gold color for vacant price
                }
                return;
            }

            el.className = 'stock-item sold';
            if ((Date.now() - data.time) < 15000) { el.classList.add('blinking-border'); setTimeout(() => el.classList.remove('blinking-border'), 15000); } 
            else { el.classList.remove('blinking-border'); }

            document.getElementById(`status-${num}`).innerText = data.owner || 'Unknown';
            document.getElementById(`price-${num}`).innerText = data.price ? '‡∏ø'+data.price : '';
            if (data.price) document.getElementById(`price-${num}`).style.color = '#ffd700'; // Normal sold price color

            const lockIcon = el.querySelector('.lock-icon');
            const sourceIcon = el.querySelector('.source-icon'); 
            if(lockIcon) lockIcon.style.display = 'none'; 

            if (sourceIcon) {
                sourceIcon.style.display = 'block';
                sourceIcon.style.position = 'absolute';
                sourceIcon.style.bottom = '5px'; sourceIcon.style.left = '5px';
                sourceIcon.style.top = 'auto'; sourceIcon.style.right = 'auto';
                sourceIcon.style.fontSize = '14px';

                if (data.source === 'ai') {
                    sourceIcon.innerHTML = '<i class="fa-solid fa-robot"></i>';
                    sourceIcon.style.color = 'var(--ai-active)';
                } else if (data.source === 'regex') {
                    sourceIcon.innerHTML = '<i class="fa-solid fa-bolt"></i>';
                    sourceIcon.style.color = 'var(--pattern-tag)';
                } else if (data.source === 'manual') {
                     sourceIcon.innerHTML = '<i class="fa-solid fa-hand-pointer"></i>';
                     sourceIcon.style.color = '#fff';
                } else {
                    sourceIcon.innerHTML = '<i class="fa-solid fa-lock"></i>';
                    sourceIcon.style.color = 'var(--primary)'; 
                }
            }

            const qBadge = document.getElementById(`qbadge-${num}`);
            if (data.queue && data.queue.length > 0) { qBadge.style.display='block'; qBadge.innerText = '+'+data.queue.length; } 
            else qBadge.style.display='none';
        }
        
        function updateStats() { 
            const total = parseInt(document.getElementById('stockSize').value) || 70;
            const soldCount = Object.keys(stockData).filter(k => stockData[k].owner).length; // Only count items with owners
            document.getElementById('sold-count').innerText = soldCount;
            document.getElementById('total-count').innerText = total;
        }

        function connectToStock(vid) {
            if (unsubscribeStock) unsubscribeStock();
            currentVideoId = vid; lastScrollTimestamp = Date.now();
            unsubscribeStock = onValue(ref(db, `stock/${vid}`), snap => {
                stockData = snap.val() || {}; renderGrid(); updateStats(); updateShippingButton();
                if(document.getElementById('dashboard').style.display === 'flex') renderDashboardTable();
            });
        }

        // --- NEW: AWAY MODE (GLOBAL SYNC FIX) ---
        onValue(ref(db, 'system/awayMode'), (snap) => {
            const val = snap.val() || {}; // Handle null
            const banner = document.getElementById('awayBanner');
            const newState = val.isAway === true;

            // Check if state actually changed to avoid loop
            if (newState !== (banner.style.display === 'flex')) {
                 if (newState) {
                     queueSpeech("‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏û‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏ô‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
                     awayStartTime = val.startTime || Date.now();
                     banner.style.display = 'flex';
                     if (!awayInterval) {
                          updateAwayTimer(); 
                          awayInterval = setInterval(updateAwayTimer, 1000); 
                     }
                 } else {
                     queueSpeech("‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏™‡πÅ‡∏ï‡∏ô‡∏ö‡∏≤‡∏¢");
                     banner.style.display = 'none';
                     if (awayInterval) {
                         clearInterval(awayInterval);
                         awayInterval = null;
                     }
                 }
            }
        });

        window.toggleAwayMode = async () => {
            try {
                const snap = await get(ref(db, 'system/awayMode'));
                const current = snap.val() || {};
                if (current.isAway) {
                    await update(ref(db, 'system/awayMode'), { isAway: false });
                } else {
                    // Update Away Mode & Enable AI
                    await update(ref(db, 'system/awayMode'), { isAway: true, startTime: Date.now() });
                    // Fix: Use set instead of update for simple string value
                    await set(ref(db, 'system/aiCommander'), myDeviceId);
                }
            } catch(e) {
                console.error("Away Mode Error", e);
            }
        };

        function updateAwayTimer() {
            if (!document.getElementById('awayBanner') || document.getElementById('awayBanner').style.display === 'none') return;
            const diff = Math.floor((Date.now() - awayStartTime) / 1000);
            const minutes = Math.floor(diff / 60);
            const seconds = diff % 60;
            const text = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('awayTimer').innerText = text;
        }

        // --- EXPORT TO WINDOW ---
        window.toggleSound = toggleSound;
        window.resetVoice = resetVoice;
        window.updateShippingButton = updateShippingButton;
        window.renderDashboardTable = renderDashboardTable;
        window.updateAllChatNames = updateAllChatNames;
        window.askName = askName; 
        window.saveStockSize = (val) => {
            set(ref(db, 'system/stockSize'), parseInt(val));
            // Fix 2: Trigger update stats immediately
            document.getElementById('total-count').innerText = val;
        };
        window.scrollToBottom = scrollToBottom;
        window.saveAddress = (uid, val) => { update(ref(db, `shipping/${currentVideoId}/${uid}`), {address: val}); };
        
        window.printLabel = (uid) => {
             let total=0, items=[]; Object.keys(stockData).forEach(n=>{ if(stockData[n].uid===uid) { items.push(`#${n} ${stockData[n].price?stockData[n].price:''}`); total+=parseInt(stockData[n].price||0); } });
             let address = "";
             if (shippingData[currentVideoId] && shippingData[currentVideoId][uid]) { address = shippingData[currentVideoId][uid].address || ""; } 
             else if (savedNames[uid]) { address = savedNames[uid].address || ""; }
             document.getElementById('print-area').innerHTML = `<div class="print-label"><div class="print-header">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö: ${savedNames[uid]?.nick||'‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤'}</div><div class="print-address">${address}</div><div class="print-items">${items.join(', ')}<br>‡∏£‡∏ß‡∏°: ${total} ‡∏ö‡∏≤‡∏ó</div></div>`; window.print();
        };
        
        // --- Fullscreen Toggle ---
        window.toggleFullScreen = () => {
            if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if (document.documentElement.webkitRequestFullscreen) {
                    document.documentElement.webkitRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                }
            }
        };

        function toggleConnection() {
            if (isConnected) {
                clearInterval(intervalId); clearInterval(viewerIntervalId); if(chatTimeoutId) clearTimeout(chatTimeoutId); isConnected = false;
                document.getElementById('btnConnect').innerText = "CONNECT"; document.getElementById('btnConnect').className = "btn btn-primary";
                document.getElementById('status-dot').className = "status-dot"; queueSpeech("‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠"); 
                chatToken = ''; return;
            }
            const vid = document.getElementById('vidInput').value.trim();
            if (!vid) return Swal.fire('Error', '‡πÉ‡∏™‡πà Video ID ‡∏Å‡πà‡∏≠‡∏ô', 'error');
            isConnecting = true; setLoading(true); if (audioCtx.state === 'suspended') audioCtx.resume();
            currentVideoId = vid; connectToStock(vid); set(ref(db, 'system/activeVideo'), vid); 
            chatToken = '';
            connectYoutube(vid).catch(e => { 
                Swal.fire({ icon: 'info', title: '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÅ‡∏•‡πâ‡∏ß', text: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡∏™‡∏î (‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏•‡∏¥‡∏õ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á) ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á/‡∏Å‡∏î‡πÄ‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', timer: 3000 });
                isConnected = true; setLoading(false); isConnecting = false;
                document.getElementById('btnConnect').innerText = "DISCONNECT"; document.getElementById('btnConnect').className = "btn btn-dark";
                document.getElementById('status-dot').className = "status-dot online";
            });
        }
        window.toggleConnection = toggleConnection;

        async function connectYoutube(vid) {
            try {
                const d = await smartFetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,liveStreamingDetails&id=${vid}`);
                if (!d.items || d.items.length === 0) throw new Error("ID ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                const item = d.items[0];
                document.getElementById('live-title').innerText = item.snippet.title;
                saveHistory(vid, item.snippet.title);
                isConnected = true; setLoading(false); isConnecting = false;
                document.getElementById('btnConnect').innerText = "DISCONNECT"; document.getElementById('btnConnect').className = "btn btn-dark";
                document.getElementById('status-dot').className = "status-dot online";
                if (item.liveStreamingDetails?.activeLiveChatId) {
                    activeChatId = item.liveStreamingDetails.activeLiveChatId; chatToken = ''; loadChat(); updateViewerCount(vid); viewerIntervalId = setInterval(()=>updateViewerCount(vid), 15000);
                } else { activeChatId = null; throw new Error("No Live Chat"); }
            } catch(e) { console.error(e); isConnected = true; setLoading(false); isConnecting = false; document.getElementById('btnConnect').innerText = "DISCONNECT"; document.getElementById('btnConnect').className = "btn btn-dark"; document.getElementById('status-dot').className = "status-dot online"; }
        }

        async function smartFetch(url) {
            try {
                updateStatusIcon('stat-api', 'ok'); let res = await fetch(url + "&key=" + API_KEYS[currentKeyIdx]); let data = await res.json();
                if (data.error) { if (currentKeyIdx < API_KEYS.length - 1) { currentKeyIdx++; return smartFetch(url); } else throw new Error(data.error.message); }
                return data;
            } catch(e) { updateStatusIcon('stat-api', 'err'); throw e; }
        }

        async function loadChat() {
            if (!isConnected || !activeChatId) return; if (isSimulating) return;
            const url = `https://www.googleapis.com/youtube/v3/liveChat/messages?liveChatId=${activeChatId}&part=snippet,authorDetails${chatToken ? '&pageToken=' + chatToken : ''}`;
            try {
                const data = await smartFetch(url);
                if (data.items) { updateStatusIcon('stat-chat', 'ok'); data.items.forEach(item => processMessage(item)); chatToken = data.nextPageToken; }
                const delay = data.pollingIntervalMillis || 5000; chatTimeoutId = setTimeout(loadChat, Math.max(delay, 3000));
            } catch(e) { console.log("Chat Fetch Error", e); updateStatusIcon('stat-chat', 'err'); chatTimeoutId = setTimeout(loadChat, 10000); }
        }

        async function updateViewerCount(vid) {
            try {
                const d = await smartFetch(`https://www.googleapis.com/youtube/v3/videos?part=liveStreamingDetails&id=${vid}`);
                if (d.items?.[0]?.liveStreamingDetails?.actualEndTime && !autoDisconnectTimer) { queueSpeech("‡πÑ‡∏•‡∏ü‡πå‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß"); autoDisconnectTimer = setTimeout(() => window.toggleConnection(), 180000); }
                if (d.items?.[0]) document.getElementById('view-counter').innerText = "üëÅÔ∏è " + Number(d.items[0].liveStreamingDetails.concurrentViewers||0).toLocaleString();
            } catch (e) { console.error("Viewer Count Error:", e); }
        }

        function syncAiCommanderStatus() {
            onValue(ref(db, 'system/aiCommander'), (snap) => {
                const commanderId = snap.val();
                const btn = document.getElementById('btnAICommander');
                if (commanderId === myDeviceId) { isAiCommander = true; btn.innerHTML = 'ü§ñ AI: ‡πÄ‡∏õ‡∏¥‡∏î (Commander)'; btn.className = 'btn btn-ai active'; } 
                else if (commanderId) { isAiCommander = false; btn.innerHTML = 'ü§ñ AI: ‡∏õ‡∏¥‡∏î (‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô‡∏Ñ‡∏∏‡∏°)'; btn.className = 'btn btn-ai remote'; } 
                else { isAiCommander = false; btn.innerHTML = 'ü§ñ AI: ‡∏õ‡∏¥‡∏î'; btn.className = 'btn btn-ai inactive'; }
            });
        }
        
        window.toggleDropdown = () => { document.getElementById("toolsDropdown").classList.toggle("show"); };
        window.addEventListener('click', (e) => {
            if (!e.target.closest('.btn-sim')) {
                var dropdowns = document.getElementsByClassName("dropdown-content");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        });

        window.askAiKey = () => { Swal.fire({ title: '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Gemini API Key', html: '<a href="https://aistudio.google.com/" target="_blank" style="color:#29b6f6">‡∏Å‡∏î‡∏Ç‡∏≠ Key ‡∏ü‡∏£‡∏µ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</a>', input: 'text', inputValue: geminiApiKey, footer: geminiApiKey ? '<span style="color:lime">‚úÖ ‡∏°‡∏µ Key ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>' : '' }).then(res => { if (res.value) { geminiApiKey = res.value.trim(); localStorage.setItem('geminiApiKey', geminiApiKey); Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß', '', 'success'); } }); };
        
        window.adjustZoom = (n) => { currentFontSize+=n; document.documentElement.style.setProperty('--chat-size', currentFontSize+'px'); };
        window.adjustGridZoom = (n) => { currentGridSize+=n; document.documentElement.style.setProperty('--grid-size', currentGridSize+'em'); };

        window.handleStockClick = (num) => {
            const current = stockData[num];
            if (current) { 
                let queueHtml = '';
                if (current.queue && current.queue.length > 0) {
                    queueHtml = '<div style="margin-top:10px; text-align:left; background:#eee; color:#000; padding:10px; border-radius:6px; border:1px solid #ccc;"><strong>‡∏Ñ‡∏¥‡∏ß‡∏ï‡πà‡∏≠:</strong><ul style="padding-left:0; margin:10px 0; list-style:none;">';
                    current.queue.forEach((q, idx) => {
                        queueHtml += `<li style="background:#fff; padding:8px; margin-bottom:4px; border-radius:4px; display:flex; justify-content:space-between; align-items:center; border:1px solid #ddd; font-size:0.95em;">
                            <span><strong style="color:#d32f2f;">${idx+1}.</strong> ${q.owner}</span>
                            <button onclick="window.removeQueue(${num}, ${idx})" style="background:#ff5252; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:0.8em;">‡∏•‡∏ö</button>
                        </li>`;
                    });
                    queueHtml += '</ul></div>';
                }
                Swal.fire({ 
                    title: `‡πÄ‡∏ö‡∏≠‡∏£‡πå ${num}`, 
                    html: `<div style="font-size:1.2em; color:#00e676; margin-bottom:10px;">${current.owner}</div><div style="display:flex; gap:5px; justify-content:center; flex-wrap:wrap;"><button onclick="window.doAction(${num}, 'edit')" class="swal2-confirm swal2-styled" style="background:#1976d2; margin:0;">‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠</button> <button onclick="window.doAction(${num}, 'price')" class="swal2-confirm swal2-styled" style="background:#555; margin:0;">‡πÅ‡∏Å‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤</button> <button onclick="window.doAction(${num}, 'cancel')" class="swal2-confirm swal2-styled" style="background:#d32f2f; margin:0;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏à‡∏≠‡∏á</button></div>${queueHtml}`, 
                    showConfirmButton: false 
                }); 
            } else { Swal.fire({title: `‡∏à‡∏≠‡∏á‡πÄ‡∏ö‡∏≠‡∏£‡πå ${num}`, input: 'text', placeholder: '‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤'}).then(r => { if (r.isConfirmed) processOrder(num, r.value || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Manual)', 'manual-'+Date.now(), 'manual'); }); }
        };
        
        window.removeQueue = (num, idx) => {
            const current = stockData[num];
            if (current && current.queue) {
                const newQ = [...current.queue];
                newQ.splice(idx, 1);
                set(ref(db, `stock/${currentVideoId}/${num}/queue`), newQ).then(() => { Swal.close(); window.handleStockClick(num); });
            }
        };

        window.doAction = (num, action) => {
            Swal.close();
            if (action === 'edit') { Swal.fire({input: 'text', inputValue: stockData[num].owner, title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ)'}).then(r => { if (r.value) { update(ref(db, `stock/${currentVideoId}/${num}`), {owner: r.value}); } }); } 
            else if (action === 'price') Swal.fire({input: 'number'}).then(r => { if(r.value) update(ref(db, `stock/${currentVideoId}/${num}`), {price: r.value}); });
            else if (action === 'cancel') processCancel(num, '‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
        };
        
        window.fixDatabase = async () => {
            const result = await Swal.fire({ title: '‡∏à‡∏±‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', text: "‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á' ‡πÅ‡∏•‡∏∞ '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà' ‡πÑ‡∏õ‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÑ‡∏•‡∏ü‡πå ‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏¢‡∏∞‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏õ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô", icon: 'warning', showCancelButton: true, confirmButtonColor: '#3085d6', cancelButtonColor: '#d33', confirmButtonText: 'üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö' });
            if (!result.isConfirmed) return;
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...', didOpen: () => { Swal.showLoading() } });
            try {
                const nickSnap = await get(ref(db, 'nicknames'));
                const updates = {};
                let count = 0;
                nickSnap.forEach(function(child) {
                    const uid = child.key; const val = child.val();
                    if (typeof val === 'object') {
                        if (val.nick) { updates[`nicknames/${uid}`] = { nick: val.nick }; } else { updates[`nicknames/${uid}`] = null; }
                        if (val.readyToShip || val.address) {
                            let targetVid = currentVideoId; 
                            const shippingPath = `shipping/${targetVid}/${uid}`;
                            const shippingPayload = {};
                            if (val.readyToShip) shippingPayload.ready = true;
                            if (val.address) shippingPayload.address = val.address;
                            if (Object.keys(shippingPayload).length > 0) { updates[shippingPath] = shippingPayload; }
                        }
                        count++;
                    }
                });
                if(count > 0) { await update(ref(db), updates); Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏à‡∏±‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ' + count + ' ‡∏£‡∏≤‡∏¢ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success'); } else { Swal.fire('‡∏õ‡∏Å‡∏ï‡∏¥', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏î‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß', 'info'); }
            } catch(e) { Swal.fire('Error', e.message, 'error'); }
        };
        
        window.clearAllStock = () => { Swal.fire({title:'‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?', showCancelButton:true}).then(r => { if(r.isConfirmed) remove(ref(db, `stock/${currentVideoId}`)); }); };
        
        window.toggleAICommander = () => {
            if (!geminiApiKey) return Swal.fire({icon:'warning', title:'‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà API Key ‡∏Å‡πà‡∏≠‡∏ô'});
            isAiCommander = !isAiCommander;
            const btn = document.getElementById('btnAICommander');
            if (isAiCommander) { btn.innerHTML = 'ü§ñ AI: ‡πÄ‡∏õ‡∏¥‡∏î (Commander)'; btn.className = 'btn btn-ai active'; queueSpeech("‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏≠‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏°‡∏°‡∏≤‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå"); } 
            else { btn.innerHTML = 'ü§ñ AI: ‡∏õ‡∏¥‡∏î'; btn.className = 'btn btn-ai inactive'; }
        };
        
        window.openTestMenu = () => {
            Swal.fire({ title: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠', showDenyButton: true, confirmButtonText: isSimulating ? 'üõë ‡∏´‡∏¢‡∏∏‡∏î‡∏à‡∏≥‡∏•‡∏≠‡∏á' : '‚ö° ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÅ‡∏ä‡∏ó', denyButtonText: 'üîë ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API Key' }).then(r => {
                if (r.isConfirmed) window.toggleSimulation();
                else if (r.isDenied) window.askAiKey();
            });
        };

        window.toggleSimulation = () => {
            isSimulating = !isSimulating; const menu = document.getElementById('menuSim');
            if (isSimulating) {
                menu.innerText = "üõë ‡∏´‡∏¢‡∏∏‡∏î‡∏à‡∏≥‡∏•‡∏≠‡∏á";
                const size = parseInt(document.getElementById('stockSize').value);
                simIntervalId = setInterval(() => {
                    const rNum = Math.floor(Math.random()*size)+1;
                    processMessage({ id: 'sim-'+Date.now(), snippet: { displayMessage: `F${rNum}` }, authorDetails: { channelId: 'sim', displayName: 'SimUser', profileImageUrl: '' } });
                }, 1500);
            } else { menu.innerText = "‚ö° ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÅ‡∏ä‡∏ó"; clearInterval(simIntervalId); }
        };
        
        window.openHistory = () => { document.getElementById('history-modal').style.display = 'flex'; loadHistoryList(); };
        window.closeHistory = () => { document.getElementById('history-modal').style.display = 'none'; };
        async function loadHistoryList() {
            const list = document.getElementById('history-list'); list.innerHTML = 'Loading...';
            const snapshot = await get(ref(db, 'history'));
            list.innerHTML = ''; const items = []; 
            snapshot.forEach(c => items.push({ id: c.key, ...c.val() }));
            items.sort((a,b)=>(b.timestamp||0)-(a.timestamp||0));
            items.forEach(i => {
                const li = document.createElement('li'); li.className = 'history-item';
                li.innerHTML = `<div><span class="hist-date">${formatThaiDate(i.timestamp||0)}</span> ${i.title||i.id}</div> <button class="btn btn-dark" onclick="window.deleteHistory('${i.id}')">üóëÔ∏è</button>`;
                li.querySelector('div').onclick = () => { window.closeHistory(); document.getElementById('vidInput').value = i.id; window.toggleConnection(); };
                list.appendChild(li);
            });
        }
        window.deleteHistory = (vid) => { Swal.fire({title:'‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥?', showCancelButton:true}).then(r=>{ if(r.isConfirmed) remove(ref(db, 'history/'+vid)).then(()=>loadHistoryList()); }); };
        window.openDashboard = () => { document.getElementById('dashboard').style.display = 'flex'; renderDashboardTable(); };
        window.closeDashboard = () => { document.getElementById('dashboard').style.display = 'none'; };
        window.toggleShowAll = () => { showAllShipping = !showAllShipping; renderDashboardTable(); };

        // INIT
        signInAnonymously(auth);
        remove(ref(db, 'stock/demo'));
        syncAiCommanderStatus();
        
        onAuthStateChanged(auth, user => {
            if (user) {
                onValue(ref(db, 'system/stockSize'), s => { 
                    const val = s.val() || 70;
                    document.getElementById('stockSize').value = val;
                    renderGrid(); 
                    updateStats(); // Ensure stats are updated when stock size loads
                });
                if (unsubscribeSystem) unsubscribeSystem();
                unsubscribeSystem = onValue(ref(db, 'system/activeVideo'), snap => {
                    const vid = snap.val();
                    if (vid && vid !== 'demo') { document.getElementById('vidInput').value = vid; connectToStock(vid); } 
                    else connectToStock('demo');
                });
                onValue(ref(db, 'nicknames'), s => { 
                    try {
                        savedNames = s.val() || {}; 
                        updateAllChatNames();
                        if(document.getElementById('dashboard').style.display === 'flex') renderDashboardTable(); 
                    } catch(e) {}
                });
                onValue(ref(db, 'shipping'), s => {
                    try {
                        shippingData = s.val() || {};
                        updateShippingButton();
                        if(document.getElementById('dashboard').style.display === 'flex') renderDashboardTable();
                    } catch(e) {}
                });
                onValue(ref(db, '.info/connected'), s => updateStatusIcon('stat-db', s.val() ? 'ok' : 'err'));
            }
        });

        setInterval(function() { if (!speechSynthesis.speaking && speechQueue.length > 0 && !isSpeaking) processQueue(); }, 1000);
        const vp = document.getElementById('chat-viewport');
        vp.addEventListener('scroll', function() { if(vp.scrollHeight - vp.scrollTop - vp.clientHeight < 100) document.getElementById('btn-scroll-down').style.display = 'none'; else document.getElementById('btn-scroll-down').style.display = 'block'; });
    </script>
</body>
</html>
